<!DOCTYPE html>
<html>
  <head>
	<script>
	var jui2 = jui2 || {
		ui:{}
	};
	</script>
    <script src="jquery.js"></script>
    <script src="dist/jui2.lib.min.js"></script>
    <script src="dist/jui2.tmp.min.js"></script>
    <script src="dist/jui2.ui.js"></script>
	<link rel="stylesheet" type="text/css" href="dist/jui2.min.css" />
	<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />
	<style>
	html, body {
        height:100%;
        margin:0;
    }
	</style>
</head>
<body>

<j-table title="Table" id="table_summary" height="100%" class="doc14">
	<j-custom target="0" width="30px">
		function(){
			return "&nbsp;";
		}
	</j-custom>
	<j-custom width="200px" target="1">
		function(record){
			if(record[14] >= 0 && record[14] <= 30)
				return '<span style="height: 100%;padding-left:'+record[14]+'px;color:blue;display: inline-block;">'+record[1]+'</span>'
			else
				return '<span style="height: 100%;padding-left:'+record[14]+'px;color:black;display: inline-block;">'+record[1]+'</span>'
		}
	</j-custom>
	<j-custom width="100px" target="4">
		function(record){
			 var color = '';
			 if (record[4] >= 0 && record[4]<= 24){
				 color = 'RED';
			 } else if (record[4] >= 25 && record[4]<= 49){
				color = 'ORANGE';
			 } else if (record[4] >= 50 && record[4]<= 74){
				 color = 'GREEN';
			 } else if (record[4] >= 75 && record[4]<= 100){
				color = '#1186FB';
			 }
			 if(color=='RED')
			 {
				return '<div style="position:relative"><font style="color:RED">'+record[4]+'</font><div style="position: absolute; width: '+record[4]+'%; background:'+color+'; height: 100%; top: 0px; left: 0px; opacity: 0.5;"> </div></div>'
			 }
			 else
			 {
				return '<div style="position:relative">'+record[4]+'<div style="position: absolute; width: '+record[4]+'%; background:'+color+'; height: 100%; top: 0px; left: 0px; opacity: 0.5;"> </div></div>'
			 }

		}
	</j-custom>
	<j-custom target="7">
		function(record){
			 return record[11];
		}
	</j-custom>
	<j-custom target="8">
		function(record){
			 return record[12];
		}
	</j-custom>
	<j-custom target="10">
		function(record){
			 return record[13];
		}
	</j-custom>
	<j-custom target="11">
		function(record){
			 return record[14];
		}
	</j-custom>
	<j-loader src="../index.php/ebike2/get_data_schedule?doc_id=14" size="200"></j-loader>
	[["&nbsp;", "Task Name", "Specification", "Task Status", "% Complete", "Resource Name", "Note", "Start Date", "Finish Target", "&nbsp;", "&nbsp;", "&nbsp;"]]
</j-table>
<j-table-inplace-form target=".doc14" clicktarget="td:nth-child(n+3)">
	<table>
		<tr>
			<td>
				<j-textfield recordno="2" id="item_type">Specification</j-textfield>
				<j-combofield id="task_status" recordno="15">Task Status
					<j-table>
						<j-loader src="../index.php/ebike/combo_task_status"></j-loader>
						[["", "Name"]]
						<j-pagination>
						</j-pagination>
					</j-table>
				</j-combofield>
			</td>
			<td>
				<j-numberfield recordno="4" id="complete_status">% Complete</j-numberfield>
				<j-textfield recordno="5" id="resource_name">Resource Name</j-textfield>
			</td>
			<td>
				<j-textarea recordno="6" id="note">Note</j-textarea>
			</td>
			<td>
				<j-datefield recordno="7" id="start_date" format="DD MMM YYYY">Start Date</j-datefield>
				<j-datefield recordno="8" id="finish_target_date" format="DD MMM YYYY">Finish Target</j-datefield>
			</td>
		</tr>
	</table>
</j-table-inplace-form>
<script>
	$('#table_summary').on('afterdraw', function(){
		var el = $(this)
		el.find('.j-table-body table tbody tr').filter(function(){
			return $(this).find('td:nth-child(11)').text()!=0
		}).hide()

		el.find('.j-table-body table tbody tr').filter(function(){
			return $(this).find('td:nth-child(11)').text()==0
		}).find('td:nth-child(2)').on('click', function(){
			var parent = $(this).parent().find('td:nth-child(10)').text()

		 el.find('.j-table-body table tbody tr td:nth-child(11)').filter(function(){
				return $(this).text() == parent
		  }).parent().toggle()
		}).filter(function(){
			var text = $(this).parent().find('td:nth-child(10)').text()
			return el.find('.j-table-body table tbody tr td:nth-child(11)').filter(function(){
				return $(this).text() == text
			}).length > 0
		}).prev().on('click', function(){
			$(this).next().trigger('click')
		}).prepend('<i class="fa fa-plus-square-o"></i>')

		//Set Padding Text
		el.find('.j-table-body table tbody tr td:nth-child(2)').each(function(i, val){
			$(this).css('padding-left',$(this).parent().find('td:nth-child(12)').text()+'px')
		})

		el.find('.j-table-body table tbody tr td:nth-child(n+10)').hide()

		el.find('.j-table-body table thead tr th:nth-child(n+10)').hide()

		el.find('.j-table-body table colgroup').filter(function(){
			return $(this).index() >= 9
		}).hide()

		el.find('.j-table-body table').css('table-layout', 'auto')
	})

	$('#printSummary').click(function(){
		var el = $('#table_summary > .j-table-body > table')
		window.open('data:application/vnd.ms-excel, ' + encodeURIComponent(el.outerHTML()));
	})

	$('#search').click(function(){
		$('#table_summary > j-loader')[0].param.sSearch = $('#searchText').val();
		$('#table_summary')[0].generateData();
	})

	$('j-table-inplace-form').on('cancel', function(e, el){
		el.parent().find('td:nth-child(n+10)').hide()

		$('#table_summary').find('.j-table-body table thead tr th:nth-child(n+10)').hide()
	})

	$('j-table-inplace-form').on('submit', function(e, el){
		el.parent().find('td:nth-child(n+10)').hide()
    var param = {}, data = el.parent().parent().parent().parent().parent()[0].data[el.parent().index()]
    el.find('td > *').each(function(i, val){
      var elTmp = $(val);
      param[elTmp.attr('id')] = elTmp.val()||'';
      data[elTmp.attr('recordno')] = elTmp.val()||'';

      if(elTmp.attr('id') == 'item_type'){
        el.parent().find('td:nth-child(3)').text(elTmp.val())
      }
      if(elTmp.attr('id') == 'task_status')
        el.parent().find('td:nth-child(4)').text(elTmp.val())
      if(elTmp.attr('id') == 'complete_status'){
        var color = '', value = parseInt(elTmp.val())
 			 if (value >= 0 && value<= 24){
 				 color = 'RED';
 			 } else if (value >= 25 && value<= 49){
 				color = 'ORANGE';
 			 } else if (value >= 50 && value<= 74){
 				 color = 'GREEN';
 			 } else if (value >= 75 && value<= 100){
 				color = '#1186FB';
 			 }
 			 if(color=='RED')
 			 {
 				var text = '<div style="position:relative"><font style="color:RED">'+value+'</font><div style="position: absolute; width: '+value+'%; background:'+color+'; height: 100%; top: 0px; left: 0px; opacity: 0.5;"> </div></div>'
 			 }
 			 else
 			 {
 				var text = '<div style="position:relative">'+value+'<div style="position: absolute; width: '+value+'%; background:'+color+'; height: 100%; top: 0px; left: 0px; opacity: 0.5;"> </div></div>'
 			 }
        el.parent().find('td:nth-child(5) div').html(text)
      }
      if(elTmp.attr('id') == 'resource_name')
        el.parent().find('td:nth-child(6)').text(elTmp.val())
      if(elTmp.attr('id') == 'note')
        el.parent().find('td:nth-child(7)').text(elTmp.val())
      if(elTmp.attr('id') == 'start_date')
        el.parent().find('td:nth-child(8)').html(param[elTmp.attr('id')] == '' ? '': param[elTmp.attr('id')]+'<input type="button" value="Del" onclick="del_start(\'162\')">')
      if(elTmp.attr('id') == 'finish_target_date')
        el.parent().find('td:nth-child(9)').html(param[elTmp.attr('id')] == '' ? '': param[elTmp.attr('id')]+'<input type="button" value="Del" onclick="del_finish(\'162\')">')
    })

    param['schedule_id'] = data[0]

		$('#table_summary').find('.j-table-body table thead tr th:nth-child(n+10)').hide()

    $.getJSON(site+'index.php/ebike2/update_list_config', param). done(function(data){
    })
	})

  function del_start(schedule_id){
			$.ajax({
				type: 'POST',
				url: site+'/ebike2/delete_date',
				data: {schedule_id: schedule_id, type:'start'},
				dataType: 'html'
			}).done(function(data) {
				var data = $.parseJSON(data);
				alert(data.message);
			}).always(function(){
				jui2('#list_schedule #table_schedule')[0].generateData();
			})
	}

	function del_finish(schedule_id){
			$.ajax({
				type: 'POST',
				url: site+'/ebike2/delete_date',
				data: {schedule_id: schedule_id, type:'finish'},
				dataType: 'html'
			}).done(function(data){
				var data = $.parseJSON(data);
				alert(data.message);
			}).always(function(){
				jui2('#list_schedule #table_schedule')[0].generateData();
			})
	}
</script>
</body>
</html>
